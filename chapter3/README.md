### 第三章 智能指针

在Android系统的应用程序框架层中，有相当一部分代码是使用C++语言开发的。我们知道，用C++来编写代码最容易出错的地方就是指针了，具体表现为忘记释放指针指向的对象所占用的内存，或者使用了无效指针。C++指针使用不当，轻则造成内存泄漏，重则造成莫名其妙的逻辑错误，甚至系统崩溃。既然如此，为什么Android系统的应用程序框架层还要使用C++语言来开发呢？全部都使用Java语言来开发不就可以解决这个问题了吗？出于性能的考虑，有时候还是不得不使用C++代码。既然无法避免使用C++代码，就要想办法避免错误地使用C++指针。因此，Android系统为我们提供了C++智能指针，避免出现指针使用不当的问题。

我们通常通过引用计数技术来维护对象的生命周期。每当有一个新的指针指向了一个对象时，这个对象的引用计数就增加1；相反，每当有一个指针不再指向一个对象时，这个对象的引用计数就减少1；当对象的引用计数为0时，它所占用的内存就可以安全地释放了。这种对象引用计数技术的核心问题是由谁来维护对象的引用计数，如果由开发人员手动地维护对象的引用计数，那么既不可靠，也不方便开发人员编写代码。一旦开发人员一不小心多增加或者多减少了对象的引用计数，那么就会造成灾难性的后果。既然手动维护方式不可取，就必须要找到一种自动的对象引用计数维护技术。

智能指针正是一种能够自动维护对象引用计数的技术。这里需要特别强调的是，智能指针是一个对象，而不是一个指针，但是它引用了一个实际使用的对象。正是因为它是一个对象，因此它能够自动地维护实际对象的引用计数。简单来说，就是在智能指针构造时，增加它所引用的对象的引用计数；而在智能指针析构时，就减少它所引用的对象的引用计数。由于智能指针的构造和析构都是自动的，因此，它就很自然地实现了自动的对象引用计数技术。

这种简单的对象引用计数技术似乎解决了C++指针的问题，然而它是存在缺陷的。考虑这样一个场景:有两个对象A和B，对象A引用了对象B，而对象B也引用了对象A。一方面，当对象A不再使用时，就可以释放它所占用的内存了，但是由于对象B仍然在引用着它，因此，此时对象A就不能被释放；另一方面，当对象B不再使用时，就可以释放它所占用的内存了，但是由于对象A仍然在引用着它，因此，此时对象B也不能被释放。这样问题就出现了，对象A等待对象B被释放，而对象B也在等待对象A被释放。除非能够同时知道对象A和对象B都不再使用了，这个问题才能解决。然而，通常系统是不知道对象之间的依赖关系的，即无法知道两个对象是否同时不再使用。这个问题也是垃圾收集(Garbage Collection)系统所遇到的经典问题之一，因为它一次只能收集一个对象所占用的内存。

这样，我们就需要采取另外一种稍为复杂的引用计数技术来维护对象的生命周期了。这种引用计数技术将对象的引用计数分为强引用计数和弱引用计数两种，其中，对象的生命周期只受强引用计数控制。在使用强引用计数和弱引用计数的解决方案中，一般将有关联的对象划分为“父-子”和“子-父”关系。在“父-子”关系中，“父”对象通过强引用计数来引用“子”对象；而在“子-父”关系中，“子”对象通过弱引用计数来引用“父”对象。这样就可以解决由于相互引用而造成对象不能释放的问题了。以上面的对象A和B为例，假设对象A和对象B是“父-子”关系，则对象B和对象A就是“子-父”关系。对象A通过强引用计数来引用对象B，而对象B通过弱引用计数来引用对象A。当对象A不再使用时，由于对象B是通过弱引用计数来引用它的，因此，对象A的生命周期不受对象B的影响，此时对象A可以安全地释放。在释放对象A时，同时也会释放它对对象B的强引用计数，因此，当对象B不再使用时，对象B也可以安全地释放了。

由于对象的生命周期不受弱引用计数控制，因此，一方面，当对象B想要使用对象A时，对象A有可能已经被释放了，这时候对象B不能直接使用对象A，而是先要成功地将对象A的弱引用计数升级为强引用计数，然后才能使用它；另一方面，如果对象B不能将对象A的弱引用计数升级为强引用计数，那么就说明对象A已经被释放了，因此，对象B就不能再使用它。

了解了这些背景知识之后，我们就可以开始学习Android系统的智能指针实现原理了。Android系统提供了三种类型的C++智能指针，分别为轻量级指针(Light Pointer)、强指针(Strong Pointer)和弱指针(Weak Pointer)，其中，轻量级指针使用了简单的引用计数技术，而强指针和弱指针使用了强引用计数和弱引用计数技术。

无论是轻量级指针，还是强指针或弱指针，它们的实现原理都是类似的，即需要对象提供引用计数器，但是由智能指针来负责维护这个引用计数器。Android系统将引用计数器定义为一个公共类，所有支持使用智能指针的对象类都必须要从这个公共类继承下来。这样，Android系统的智能指针就可以通过这个引用计数器来维护对象的生命周期了。

在本章接下来的内容中，我们首先介绍轻量级指针的实现原理，然后介绍强指针和弱指针的实现原理。